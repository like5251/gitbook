## B树(B-Tree)
B树是为磁盘存取（如文件系统、数据库索引）而设计的一种**多路平衡查找树**。许多数据库系统使用B树或B树的变种来存储信息，如著名的非关系型数据库MongoDB数据库索引使用的就是B树，而大部分关系型数据库如Mysql则使用B+树作为索引。

>「B-树」和「B树」，都是对 B-tree 的翻译，里面不是减号-，是连接符-。同时因为「B+树」的存在，更会让人误以为「B树」和「B-树」是两种树，实际上两者就是同一种树。

> Rudolf Bayer 和 Ed McCreight 于1972年，在Boeing Research Labs 工作时发明了B 树，但是他们没有解释B代表什么意义（如果有的话）。Douglas Comer 解释说: 两位作者从来都没解释过B树的原始意义。正如我们所见，“balanced”， “broad” 或 “bushy” 可能适合。其他人建议字母“B”代表 Boeing。源自于他的赞助，不过，看起来把B树当作“Bayer”树更合适些。Donald Knuth 在他1980年5月发表的题为“CS144C classroom lecture about disk storage and B-trees”的论文中推测了B树的名字取义，提出“B”可能意味Boeing 或者Bayer 的名字。

### 磁盘存取模型
在典型的B树应用中，通常所要处理的数据量非常巨大，以至于所有数据无法一次装入内存，需要将所需页面从磁盘复制到内存，然后将修改过的页面写回磁盘，磁盘操作的典型**模型**如下：

```python
x = 磁盘中某对象的指针
DISK_READ(x)
访问或修改x
DISK_WRITE(x)
```
磁盘操作算法的**运行时间**主要由两部分构成：
- 磁盘存取次数：由树高决定
- CPU计算时间：由节点的度决定

磁盘存取所花费的时间要远远大于数据在内存中处理的时间，一个B树算法的运行时间主要由磁盘存取次数决定，所以我们希望每次能够存取尽可能多的数据来降低树高提高存取效率。一个B树节点通常和一个完整磁盘页一样大，磁盘页的大小限制了一个B树节点可以含有的孩子数。

典型的二叉查找树结构如BST和RBT，在动态存取内存数据时效率很高，但考虑到磁盘IO，算法的运行时间主要由树高来决定，它们还是显得太过“瘦高”，一个基本的想法就是采用多叉树来让它们变得“矮胖”，这就是我们接下来所要讨论多路平衡二叉树，即B树。

### B树定义
B树的阶：B树中所有节点的孩子节点树的最大值称为B树的阶，记做m，令t = $$\left \lceil \frac{m}{2} \right \rceil$$。

一棵m阶B树或者为空或者满足以下特性：

1. 根节点有2~m个棵子树
2. 内部节点有t~m棵子树
3. 所有叶节点都出现最同一层，且不带任何信息，实际这些节点并不存在
4. 每个非终端结点中包含有n个关键字信息：$$(n,P_{0},K_{1},P_{1},K_{2},P_{2},...,K_{n},P_{n})$$
  1. $$K_{i} (i=1...n)$$为关键字，且每个节点中关键字按顺序升序排序。
  2. $$P_{i}$$为指向子树根的结点，且指针P(i-1)指向子树中所有结点的关键字均小于Ki，大于$$K_{i-1}$$
  3. 关键字的个数n必须满足：$$t-1 \leqslant  n \leqslant  m-1$$

最简单的B树为3阶B树，每个非终端节点允许有2或3个子树，每个非终端节点中有1或2个关键字，又称2-3树。

![](https://github.com/julycoding/The-Art-Of-Programming-By-July/raw/master/ebook/images/7/6.jpg)

```python
class Node(object):
    def __init__(self,key):
        self.key1=key
        self.key2=None
        self.left=None
        self.middle=None
        self.right=None
```

### B树高度
B树操作所需的磁盘存取次数与B树高度成正比。一般所讨论的B树高度不包括叶节点那一层。

- 最坏情况下，所有节点中关键字个数都达到最小，第一层节点数有1个，第二层节点数有2个，第三层有2t个...，叶节点个数 $$n+1 = 2t^{h-1}$$
- 最好情况下，b树为满m叉树，节点个数$$n = m^{h}-1$$

$$
log_{m} (n+1)\leqslant h\leqslant log_{t}(\frac{n+1}{2})
$$

虽然B树和RB树高度都是以O(lgn)速度增长，但是B树的底数要大得多，B树避免了大量的磁盘访问。

### 查找
#### 查找过程
B树查找包括以下两个基本操作：
1. 在B树中查找节点：B树常存在与磁盘上，该操作是在磁盘上进行的
2. 在节点内查找关键字：在内存中进行，找到目标节点后，先将节点信息读入内存，再用顺序查找或折半查找寻找目标关键字，若找打则查找成功，否则按照对应的指针信息到对应子树中进行查找，当找到叶节点时说明查找失败

#### 时间复杂度

- 磁盘访问次数：$$O(h) = O(log_{t}n)$$
- CPU计算时间：$$O(th) = O(tlog_{t}n)$$

### 插入
#### 与BST插入的区别：

1. BST将新插入的节点作为新的叶节点插入，B树将关键字插入到最底层已存在的非叶节点(终端节点)中；
2. BST插入新节点后无需调整，B树插入关键字后，如果节点超出规定关键字个数则需要“分裂”，以保持B树性质不变

#### 插入过程：

1. 定位：先通过查找定位出最底层的某个非叶结点，作为初始插入位置
2. 分裂：如果插入位置未满则直接插入，如果已满则分裂，并将中间关键字添加至父节点，父节点也满了则继续分裂父节点

a) 节点未满：直接插入即可

![](http://images.cnitblog.com/i/601033/201406/172221493649446.jpg)

b) 节点已满：需要将节点分裂为两个节点，并将中间关键字添加至父节点中，若父节点已满再以同样方式分裂父节点，直至某祖先未满或达到根节点为止，此时B树高度增加1

![](http://images.cnitblog.com/i/601033/201406/172224368955528.jpg)

![](http://images.cnitblog.com/i/601033/201406/172225438486050.jpg)
    
![](http://images.cnitblog.com/i/601033/201406/172233360517844.jpg)

#### 时间复杂度
- 磁盘访问次数：$$O(h) = O(log_{t}n)$$
- CPU计算时间：$$O(th) = O(tlog_{t}n)$$

### 删除
#### 删除过程
删除操作比插入操作需要考虑的情况多一些，[动画演示](http://student.zjzk.cn/course_ware/data_structure/web/flashhtml/bshushanchu.htm)

- **情形一**： 如果要删除的关键字k在终端节点：

a) 直接删除：如果节点中的关键字个数>t-1，则直接删除

![](http://img842.ph.126.net/TBEBr7dmNsywOSQ0oivxmw==/872572427804609467.png)

b) 兄弟够借：如果节点中的关键字个数=t-1，且与此节点相邻的右（左）兄弟节点关键字个数>t-1，则将关键字删除后通过"父子换位法"达到平衡

![](http://img842.ph.126.net/yF6PSGyHlGudFo-t5-zAeQ==/872572427804609474.png)

c) 兄弟不够借：如果节点中的关键字个数=t-1，且与此节点相邻的右（左）兄弟节点关键字个数=t-1，则将该关键字删除后，将该节点与右(左)兄弟及双亲节点中的关键字进行合并，合并后双亲节点中关键字会减少，若双亲不是根节点则重复以上过程，若双亲是根节点并且关键字个数减至0，则直接将根节点删除

![](/assets/3133660915721480375.png)

- **情形二**：如果要删除的关键字k不在终端节点：

a) 如果k的左子树/右子树中关键字个数>t-1，则找到k的前驱/后继关键字k'，则用k'代替k，再递归删除k'即可

![](/assets/1443685155550413560.png)

b) 如果左右两子树中关键字个数均为t-1，则直接将两个子节点合并，删除k即可

#### 时间复杂度
- 磁盘访问次数：$$O(h) = O(log_{t}n)$$
- CPU计算时间：$$O(th) = O(tlog_{t}n)$$


## 参考
[漫画算法：什么是 B 树？](http://blog.jobbole.com/111757/)

[B树及2-3树的python实现](http://www.cnblogs.com/linxiyue/p/3704794.html)

[B树](https://github.com/julycoding/The-Art-Of-Programming-By-July/blob/master/ebook/zh/03.02.md)



